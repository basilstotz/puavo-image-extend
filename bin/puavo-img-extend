#!/bin/sh


#if ! test $(id --user) = 0;then
#    exec sudo $0 $@
#fi

UTILS="$(dirname $0)/utils"



on_exit(){
    #generic-img-mount --umount $SOURCE
    test -f $IMAGE.img && chown --reference ..  $IMAGE.img
}


help(){
    echo "Usage: $(basename $0) [options] datadir source_image"
    echo
    echo "Patch a PuavoOS image and compress a new image."
    echo
    echo "    -o, --osname <osname> (default: $OSNAME)"
    echo "    -c, --class <class> (default: $CLASS)"
    echo "    -h, --help"
    echo
    exit 0
}


puavo_mount(){
    $UTILS/generic-img-mount $1
    if test $? -ne 0;then
       echo "could not mount \"$SOURCE\""
       exit 1
    fi
    CHROOT=$(basename -s .img $1)
}

puavo_patch(){
    mkdir -p $CHROOT/opt/puavo-extend
    cp -r $1/* $CHROOT/opt/puavo-extend/

    echo "run-parts --regex=\"^[0-9]{2}-.*$\" /opt/puavo-extend" | $UTILS/puavo-dir-chroot $CHROOT
    if test $? -ne 0;then
       echo "could not patch \"$1\""
       exit 1
    fi

    #rm -r $CHROOT/opt/puavo-extend
}

puavo_image(){    
    $UTILS/puavo-make-image $CHROOT $1 $2
    if test $? -ne 0;then
       echo "could not make image"
       exit 1
    fi
    
}


CURRENT_IMAGE=$(cat /etc/puavo-image/name)
OSNAME=$(echo $CURRENT_IMAGE|cut -d- -f1-2)
CLASS=$(echo $CURRENT_IMAGE|cut -d- -f3)

while [ $# -gt 0 ]; do
    case $1 in
	-h|--help)
	    shift
	    help
	    ;;
	#config 
	-o|--osname)
	    shift
	    OSNAME=$1
	    shift
	    ;;
	-c|--class)
	    shift
	    CLASS=$1
	    shift
	    ;;
	--)
	    shift
	    break
	    ;;
	-*)
	    echo "error: invalid argument '$1'"
	    exit 1
	    ;;
	*)
	    break
	    ;;
    esac
done


# some paramter checks
if [ $# -ne 2 ]; then
    echo ch "invalid number of arguments ($#), expected 2"
    help
    exit 1
fi

DATADIR=$1
SOURCE=$2
exit


###################################################################################
###################################################################################


if ! test -f $SOURCE; then
	echo "error: source file not found"
	exit 1
fi

##################################################################################
###################################################################################



trap on_exit EXIT
trap on_exit INT

puavo_mount  $SOURCE
puavo_patch  $DATADIR > ./last-build.log
puavo_image  $OSNAME $CLASS


exit 0
