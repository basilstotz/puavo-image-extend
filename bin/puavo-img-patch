#!/bin/sh


#if ! test $(id --user) = 0;then
#    exec sudo $0 $@
#fi

UTILS="$(dirname $0)/../utils"


on_exit(){
    #generic-img-mount --umount $SOURCE
    test -f $IMAGE.img && chown --reference ..  $IMAGE.img
}


puavo_mount(){
    SOURCE=$1
    
    $UTILS/generic-img-mount $SOURCE
    if test $? -ne 0;then
       echo "could not mount \"$SOURCE\""
       exit 1
    fi
    CHROOT=$(basename -s .img $SOURCE)
    return $CHROOT
}

puavo_patch(){
    CHROOT=$1
    DATA=$2
    
    mkdir -p $CHROOT/install
    cp -r $DATA/* $CHROOT/install/

    echo "/install/puavo-chroot-apply" | $UTILS/puavo-dir-chroot $CHROOT
    STATUS=$?

    rm -r $CHROOT/install

    return $STATUS
}

puavo_image(){
    CHROOT=$1
    OSNAME=$2
    CLASS=$3
    
    $UTILS/puavo-make-image $CHROOT $OSNAME $CLASS
}



CURRENT_IMAGE=$(cat /etc/puavo-image/name)
OSNAME=$(echo $CURRENT_IMAGE|cut -d- -f1-2)
CLASS=$(echo $CURRENT_IMAGE|cut -d- -f3)

REPOSITORY=$(puavo-conf puavo.image.servers|xargs|cut -d\  -f1)
GNUPG=""

while [ $# -gt 0 ]; do
    case $1 in
	-h|--help)
	    shift
	    echo "Usage: $(basename $0) source_image"
	    echo "       $(basename $0) [options]"
	    echo
	    echo "Patch a PuavoOS image and compress a new image." 
 	    echo "    -g, --gnupg <directory>"
	    echo "    -r, --repository <hostname> ($REPOSITORY)"
 	    echo "    -o, --osname <osname> ($OSNAME)"
	    echo "    -c, --class <lcass> ($CLASS)"
 	    echo "    -h, --help"
	    echo
	    exit 0
	    ;;

	#config 
	-o|--osname)
	    shift
	    OSNAME=$1
	    shift
	    ;;
	-c|--class)
	    shift
	    CLASS=$1
	    shift
	    ;;
	-r|--repository)
	    shift
	    REPOSITORY=$1
	    shift
	    ;;
	-g|--gnupg)
	    shift
	    GNUPG=$1
	    shift
	    ;;
	--)
	    shift
	    break
	    ;;
	-*)
	    echo "error: invalid argument '$1'"
	    exit 1
	    ;;
	*)
	    break
	    ;;
    esac
done

#setup config
if test -z "$REPOSITORY"; then
    if test -f config/parts.d/gnugpg/repository; then
	REPOSITORY=$(cat config/parts.d/gnugpg/repository)
    else
	echo "error: repository not set. run: $(basename $0) --repository <repository>. "
	exit 1
    fi
else
    mkdir -p config/parts.d/gnugpg
    echo $REPOSITORY > config/parts.d/gnugpg/repository
fi


if test -z "$GNUPG"; then
    if ! test -d config/parts.d/gnugpg/pkg/; then
	echo "error: public keys not set. run: $(basename $0) --gnupg <dir>. "
	exit 1
    fi
else
    mkdir -p config/parts.d/gnugpg/pkg
    cp $GNUPG/pubring.kbx config/parts.d/gnugpg/pkg/.
    cp $GNUPG/trustdb.gpg config/parts.d/gnugpg/pkg/.
fi

if test -z "$OSNAME"; then
    if test -f config/options.d/osname; then
       OSNAME=$(cat config/options.d/osname)
    fi
else
    mkdir -p config/options.d
    echo $OSNAME > config/options.d/osname
fi

if test -z "$CLASS"; then
    if test -f config/options.d/class; then
       OSNAME=$(cat config/options.d/class)
    fi
else
    mkdir -p config/options.d
    echo $CLASS > config/options.d/class
fi

if test -f packages.puavo; then
    cp packages.puavo config/parts.d/puavoconf/packages.list
else
    echo "info: you have no packages.puavo file, you will not be able to use puavo-pkg"
fi

if test -f packages.debian; then
    mkdir -p config/lists.d
    cp packages.debian config/lists.d/packages.list
else
    echo "info: you have no packages.debian file, you will not install any packages"
fi

echo $OSNAME $CLASS $REPOSITORY 


# some paramter checks
if [ $# -ne 1 ]; then
    echo ch "invalid number of arguments ($#), expected 1"
    exit 1
fi

exit

SOURCE=$1
if ! test -f $SOURCE; then
	echo "error: source file not found"
	exit 1
else
    if ! mount $SOURCE /mnt/; then
	echo "error: could not mount $SOURCE"
	exit 1
    fi    
    imagename=$(cat /mnt/etc/puavo-image/name)
    umount /mnt
    
    DIST=$(basename $imagename|cut -d- -f4)
fi

##################################################################################
###################################################################################
#                     ready now. mount the source image                           #
###################################################################################
###################################################################################

$DATA=./config


trap on_exit EXIT
trap on_exit INT


CHROOT=$(puavo_mount $SOURCE)

puavo_patch $CHROOT  $DATA > ./last-build.log

if test $? = 0; then
    puavo_image $CHROOT $OSNAME $CLASS
fi

exit 0
