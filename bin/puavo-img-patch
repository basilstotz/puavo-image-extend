#!/bin/sh


if ! test $(id --user) = 0;then
    exec sudo $0 $@
fi

on_exit(){
    #generic-img-mount --umount $SOURCE
    test -f $IMAGE.img && chown --reference ..  $IMAGE.img
}


CURRENT_IMAGE=$(cat /etc/puavo-image/name)
OSNAME=$(echo $CURRENT_IMAGE|cut -d- -f1-2)
CLASS=$(echo $CURRENT_IMAGE|cut -d- -f3)



while [ $# -gt 0 ]; do
    case $1 in
	-h|--help)
	    shift
	    echo "Usage: $(basename $0) [options] datadir source_image"
	    echo
	    echo "Patch a PuavoOS image and compress a new image." 
	    echo
 	    echo "    -o, --osname ($OSNAME)"
	    echo "    -c, --class ($CLASS)"
	    echo "    -d, --dist"
 	    echo "    -h, --help"
	    echo
	    exit 0
	    ;;

	#config 
	-o|--osname)
	    shift
	    OSNAME=$1
	    shift
	    ;;
	-c|--class)
	    shift
	    CLASS=$1
	    shift
	    ;;
	-d|--dist)
	    shift
	    DIST=$1
	    shift
	    ;;
	--)
	    shift
	    break
	    ;;
	-*)
	    echo "error: invalid argument '$1'"
	    exit 1
	    ;;
	*)
	    break
	    ;;
    esac
done

# some paramter checks
if [ $# -ne 2 ]; then
    echo  "invalid number of arguments ($#), expected 2"
    exit 1
fi


DATA_DIR=$1
if ! test -d $DATA_DIR/parts.d; then
        echo "error: datadir not found"
        exit 1
fi

SOURCE=$2
if ! test -f $SOURCE; then
	echo "error: source file not found"
	exit 1
fi	

DIST=$(basename $SOURCE|cut -d- -f4)

##################################################################################
###################################################################################
#                     ready now. mount the source image                           #
###################################################################################
###################################################################################

trap on_exit EXIT
trap on_exit INT



generic-img-mount $SOURCE
if test $? -ne 0;then
    echo "could not mount \"$SOURCE\""
    exit 1
fi
CHROOT=$(basename -s .img $SOURCE)

echo $CHROOT


mkdir -p $CHROOT/install

ls $DATA_DIR

pwd

cp -r $DATA_DIR/* $CHROOT/install/



$(dirname $0)/generic-dir-patch $CHROOT  > ./log/last-build.log
RET="$?"
if test $RET -ne 0;then
    echo "could not patch \"$SOURCE\""
    exit 1
fi


###################################################################################
###################################################################################
#                                we start compressing the image                        #
###################################################################################
###################################################################################
echo
echo "info: compressing image ..."

# clean chroot
test -d $CHROOT/install && rm -r $CHROOT/install
test -d $CHROOT/var/cache/apt/archives/ && rm -r $CHROOT/var/cache/apt/archives/
mkdir $CHROOT/var/cache/apt/archives/


# update some vlaues in /etc/puavo-image
if ! test -f $CHROOT/etc/puavo-image/base_name;then
   cp $CHROOT/etc/puavo-image/name $CHROOT/etc/puavo-image/base_name
fi
if ! test -f $CHROOT/etc/puavo-image/base_release;then
   cp $CHROOT/etc/puavo-image/release $CHROOT/etc/puavo-image/base_release
fi
if ! test -f $CHROOT/etc/puavo-image/base_class;then
   cp $CHROOT/etc/puavo-image/class $CHROOT/etc/puavo-image/base_class
fi
echo "${IMAGE}.img" > $CHROOT/etc/puavo-image/name
echo "$( cat $CHROOT/etc/puavo-image/base_release ) (${VERSION})" > $CHROOT/etc/puavo-image/release
echo "$CLASS" > $CHROOT/etc/puavo-image/class
echo "${IMAGE}.img" > $CHROOT/etc/puavo-image/name
echo "$( cat $CHROOT/etc/puavo-image/release ) (${VERSION})">$CHROOT/etc/puavo-image/release
echo "$CLASS" > $CHROOT/etc/puavo-image/class

#compose new image name
VERSION=$(date +%Y-%m-%d-%H%M%S)
IMAGE="${OSNAME}-${CLASS}-${DIST}-${VERSION}-amd64"


#    make compressed image
mksquashfs  $CHROOT ${IMAGE}.img -noappend -no-recovery

on_exit

exit 0
